- hosts: snmp_machine
  vars:
    user: ubuntu
    dir: /home/ubuntu
  tasks:
  - name: Run automatic_setup.sh
    command: |
      sudo apt -y install docker.io
      cd ~/splunk-connect-for-snmp

      echo $(green "Building Docker image")

      sudo docker build -t snmp-local .

      sudo docker save snmp-local > myimage.tar
      sudo microk8s ctr image import myimage.tar
    args:
      chdir: "{{ dir }}/splunk-connect-for-snmp/integration_tests/"

  - name: Run mikrok8s command
    become: yes
    command: microk8s helm3 install snmp -f values.yaml /home/ubuntu/splunk-connect-for-snmp/charts/splunk-connect-for-snmp --namespace=sc4snmp --create-namespace &
    args:
      chdir: "{{ dir }}/splunk-connect-for-snmp/integration_tests/"